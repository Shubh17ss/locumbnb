import{r as d,s as n}from"./index-Hl5FDKDL.js";const O=()=>{const[m,p]=d.useState(null),[I,_]=d.useState(0),[N,c]=d.useState(!0),[C,g]=d.useState(null),[b,S]=d.useState(!1),w=s=>{const t=Object.values(s),i=t.filter(Boolean).length;return Math.round(i/t.length*100)},P=s=>Object.values(s).every(Boolean),E=s=>String(s??"").replace(/\D/g,""),U=s=>E(s).slice(0,10),y=async()=>{try{c(!0);const{data:{user:s}}=await n.auth.getUser();if(!s){g("No authenticated user"),S(!1),c(!1);return}S(!0);const{data:t,error:i}=await n.from("physician_profiles").select("*").eq("user_id",s.id).maybeSingle();if(i){console.error("Error fetching profile:",i),g(i.message),c(!1);return}if(t){const a=!!t.npi_number||!!t.dea_number||!!t.specialty||!!t.subspecialty||t.years_experience!==null&&t.years_experience!==void 0&&t.years_experience!==""||typeof t.board_certified=="boolean"||!!t.board_certification_details,e={userId:t.user_id,personalIdentifiers:t.first_name?{firstName:t.first_name,middleName:t.middle_name,lastName:t.last_name,email:t.email,dateOfBirth:t.date_of_birth,ssnLastFour:t.ssn_last_four,phoneNumber:t.phone_number,address:{line1:t.address_line1,line2:t.address_line2,city:t.city,state:t.state,zipCode:t.zip_code}}:null,professionalInformation:a?{npiNumber:t.npi_number?String(t.npi_number):"",deaNumber:t.dea_number||"",specialty:t.specialty||"",subspecialty:t.subspecialty||"",yearsExperience:t.years_experience??"",boardCertified:typeof t.board_certified=="boolean"?t.board_certified:null,boardCertificationDetails:t.board_certification_details||""}:null,travelPreferences:t.travel_preferences||null,licenses:t.licenses||[],documents:t.documents||[],questionnaires:t.questionnaires||[],digitalSignature:t.digital_signature?{signature:t.digital_signature,timestamp:t.signature_timestamp,ipAddress:t.signature_ip,attestationAgreed:t.attestation_agreed}:null,completionStatus:(()=>{const r=t.completion_status||{};return{personalIdentifiers:r.personalIdentifiers||!1,professionalInformation:r.professionalInformation||!1,licensure:r.licensure||!1,documentUploads:r.documentUploads||!1,questionnaires:r.standardQuestionnaires||r.questionnaires||!1,digitalSignature:r.digitalAttestation||r.digitalSignature||!1}})(),isComplete:t.is_complete||!1,lastUpdated:t.updated_at};p(e),_(t.completion_percentage||0)}else{const a={userId:s.id,personalIdentifiers:null,professionalInformation:null,travelPreferences:null,licenses:[],documents:[],questionnaires:[],digitalSignature:null,completionStatus:{personalIdentifiers:!1,professionalInformation:!1,licensure:!1,documentUploads:!1,questionnaires:!1,digitalSignature:!1},isComplete:!1,lastUpdated:new Date().toISOString()};console.log("Creating new profile in database for user:",s.id);const{error:e}=await n.from("physician_profiles").insert({user_id:s.id,completion_status:a.completionStatus,is_complete:!1,completion_percentage:0,created_at:new Date().toISOString(),updated_at:new Date().toISOString()});e?console.error("Error creating profile:",e):console.log("New profile created successfully"),p(a),_(0)}c(!1)}catch(s){console.error("Error in fetchProfile:",s),g("Failed to load profile"),c(!1)}},z=async(s,t)=>{if(!b){console.warn("Cannot update completion status: User not authenticated");return}try{const{data:{user:i}}=await n.auth.getUser();if(!i){console.error("No user found when updating completion status");return}const e={...m?.completionStatus||{personalIdentifiers:!1,professionalInformation:!1,licensure:!1,documentUploads:!1,questionnaires:!1,digitalSignature:!1},[s]:t},r={...e};s==="questionnaires"&&(r.standardQuestionnaires=t),s==="digitalSignature"&&(r.digitalAttestation=t);const o=P(e),l=w(e);console.log("Updating completion status:",{section:s,isComplete:t,newStatus:e,isProfileComplete:o,percentage:l});const{error:f}=await n.from("physician_profiles").upsert({user_id:i.id,completion_status:r,is_complete:o,completion_percentage:l,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(f){console.error("Error updating completion status:",f);return}console.log("Completion status updated successfully"),p(u=>u?{...u,completionStatus:e,isComplete:o,lastUpdated:new Date().toISOString()}:null),_(l)}catch(i){console.error("Error in updateCompletionStatus:",i)}},q=async s=>{if(!b){console.warn("Cannot update profile: User not authenticated");return}try{const{data:{user:t}}=await n.auth.getUser();if(!t){console.error("No user found when updating profile");return}const i={user_id:t.id,updated_at:new Date().toISOString()};if(s.personalIdentifiers){const e=s.personalIdentifiers;(e.legalFirstName||e.firstName||e.first_name)&&(i.first_name=e.legalFirstName||e.firstName||e.first_name),(e.legalMiddleName||e.middleName||e.middle_name)&&(i.middle_name=e.legalMiddleName||e.middleName||e.middle_name),(e.legalLastName||e.lastName||e.last_name)&&(i.last_name=e.legalLastName||e.lastName||e.last_name),(e.dateOfBirth||e.date_of_birth)&&(i.date_of_birth=e.dateOfBirth||e.date_of_birth),(e.ssnLastFour||e.ssn_last_four)&&(i.ssn_last_four=e.ssnLastFour||e.ssn_last_four),(e.phone||e.phoneNumber||e.phone_number)&&(i.phone_number=e.phone||e.phoneNumber||e.phone_number),e.email&&(i.email=e.email),e.address&&typeof e.address=="object"?((e.address.line1||e.address.address)&&(i.address_line1=e.address.line1||e.address.address),e.address.line2&&(i.address_line2=e.address.line2),e.address.city&&(i.city=e.address.city),e.address.state&&(i.state=e.address.state),(e.address.zipCode||e.address.zip||e.address.zip_code)&&(i.zip_code=e.address.zipCode||e.address.zip||e.address.zip_code)):(e.address&&(i.address_line1=e.address),e.city&&(i.city=e.city),e.state&&(i.state=e.state),(e.zipCode||e.zip_code)&&(i.zip_code=e.zipCode||e.zip_code))}if(s.professionalInformation){const e=s.professionalInformation,r=U(e.npiNumber??e.npi_number);r.length>0&&(i.npi_number=r);const o=String(e.deaNumber??e.dea_number??"").trim();o&&(i.dea_number=o);const l=String(e.specialty??"").trim();l&&(i.specialty=l);const f=String(e.subspecialty??"").trim();f&&(i.subspecialty=f);const u=String(e.yearsExperience??e.years_experience??"").trim();u!==""&&(i.years_experience=u),typeof e.boardCertified=="boolean"?i.board_certified=e.boardCertified:typeof e.board_certified=="boolean"&&(i.board_certified=e.board_certified);const h=String(e.boardCertificationDetails??e.board_certification_details??"").trim();h&&(i.board_certification_details=h)}s.optionalPreferences&&(i.travel_preferences=s.optionalPreferences),s.licenses&&(i.licenses=s.licenses),s.documents&&(i.documents=s.documents),s.questionnaires&&(i.questionnaires=s.questionnaires),s.digitalSignature&&(i.digital_signature=s.digitalSignature.signature,i.signature_timestamp=s.digitalSignature.timestamp,i.signature_ip=s.digitalSignature.ipAddress,i.attestation_agreed=s.digitalSignature.attestationAgreed),console.log("Saving profile updates:",i);const{error:a}=await n.from("physician_profiles").upsert(i,{onConflict:"user_id"});if(a){console.error("Error updating profile:",a);return}console.log("Profile updated successfully"),p(e=>e?{...e,...s,lastUpdated:new Date().toISOString()}:null)}catch(t){console.error("Error in updateProfile:",t)}};return d.useEffect(()=>{y()},[]),{profile:m,completionPercentage:I,updateCompletionStatus:z,updateProfile:q,isProfileComplete:m?.isComplete||!1,loading:N,error:C,refetch:y,isAuthenticated:b}};export{O as u};
//# sourceMappingURL=useProfileCompletion-s7Uo8Mqq.js.map
